<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Terrible Tractors (Retro)</title>
<style>
:root{
  --bg:#0b1020; --ui:#e5e7f2; --road:#30323d; --lane:#c7c9da;
  --ramp:#ffd166; --danger:#ff3366; --good:#00e1a7;
}
html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 50% 150%,#151a30,var(--bg));color:var(--ui);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif}
.wrap{display:grid;place-items:center;height:100%}
.screen{position:relative;width:min(95vw,900px);height:min(65vh,600px);max-width:1000px;border-radius:18px;overflow:hidden;background:linear-gradient(#0c1430,#151a36 40%,#0c1430 98%);box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06)}
canvas{position:absolute;inset:0;width:100%;height:100%}
.scanlines{position:absolute;inset:0;pointer-events:none;opacity:.18;background:repeating-linear-gradient(0deg,rgba(255,255,255,.08) 0px, rgba(255,255,255,.08) 1px, transparent 2px, transparent 4px);mix-blend-mode:overlay}
.vignette{position:absolute;inset:-6%;pointer-events:none;background:radial-gradient(120% 85% at 50% 50%, transparent 60%, rgba(0,0,0,.45) 85%)}
.retro-on .screen{filter:saturate(1.2) contrast(1.1) hue-rotate(-5deg)}
.hud{position:fixed;inset:16px auto auto 16px;display:flex;gap:12px;align-items:center;font-weight:600}
.card{backdrop-filter: blur(6px);background:rgba(12,20,48,.35);border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
.right{position:fixed;inset:16px 16px auto auto;display:flex;gap:10px;align-items:center}
.btn{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;background:linear-gradient(180deg,#1f274a,#141a34);color:var(--ui);font-weight:700;letter-spacing:.2px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 8px 24px rgba(0,0,0,.35)}
.btn:active{transform:translateY(1px)}
.help{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);max-width:min(92vw,900px);line-height:1.4}
.kbd{display:inline-block;min-width:1.8ch;text-align:center;padding:.1rem .35rem;border-radius:.5rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15)}
.banner{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center}
.title{font-size:clamp(28px,4vw,46px);font-weight:900;letter-spacing:.8px;margin:6px 0 8px}
.subtitle{opacity:.85;margin:0 0 14px}
.small{font-size:.9rem;opacity:.85}
.hidden{display:none}
.toast{position:fixed;left:50%;top:12%;transform:translateX(-50%);padding:10px 14px;border-radius:11px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.14);opacity:0;transition:opacity .25s ease;pointer-events:none}
.toast.show{opacity:1}
</style>
</head>
<body class="retro-on">
  <div class="wrap">
    <div class="screen">
      <canvas id="game" width="960" height="600" aria-label="Terrible Tractors game area"></canvas>
      <div class="scanlines" aria-hidden="true"></div>
      <div class="vignette" aria-hidden="true"></div>
    </div>
  </div>

  <div class="hud">
    <div class="card">Score: <span id="score">0</span></div>
    <div class="card">Speed: <span id="speed">1.0x</span></div>
    <div class="card">Stage: <span id="stage">Road</span></div>
  </div>

  <div class="right">
    <button class="btn" id="retroBtn" aria-label="Toggle Retro">üïπÔ∏è Retro ‚úì</button>
    <button class="btn" id="pauseBtn" aria-label="Pause">‚è∏Ô∏è Pause</button>
    <button class="btn" id="restartBtn" aria-label="Restart">üîÅ Restart</button>
  </div>

  <div class="help card">
    <b>Controls:</b> <span class="kbd">Z</span>/<span class="kbd">X</span> steer ¬∑ <span class="kbd">Space</span> boost ¬∑ <span class="kbd">P</span> pause ¬∑ <span class="kbd">R</span> restart
  </div>

  <div id="startBanner" class="banner">
    <div class="card" style="padding:18px 22px;">
      <div style="font-size:46px">üê∂üèçÔ∏èüåæ</div>
      <div class="title">Terrible Tractors</div>
      <div class="subtitle">Vintage bike. Dog with goggles. Dodge monster tractors. Hit ramps to jump. Bark on every clean jump. Survive the harvest.</div>
      <div class="small">Press <span class="kbd">Space</span> to start ¬∑ <span class="kbd">Z</span>/<span class="kbd">X</span> to steer</div>
    </div>
  </div>

  <div id="toast" class="toast">WOOF! +10</div>

<script>
(()=>{
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const scoreEl = document.getElementById('score');
  const speedEl = document.getElementById('speed');
  const stageEl = document.getElementById('stage');
  const startBanner = document.getElementById('startBanner');
  const toast = document.getElementById('toast');
  const pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn');
  const retroBtn = document.getElementById('retroBtn');

  const LANES = 5, ROAD_W_TOP = W*0.12, ROAD_W_BOTTOM = W*0.7, HORIZON = H*0.18;
  const BOOST_MULT = 1.55, TURN_SPEED = 0.18;
  const STAGE = { ROAD:'Road', HARVEST:'Harvest', FINAL:'Finale', CELEB:'Celebrate' };

  const rand=(a,b)=>Math.random()*(b-a)+a;
  const clamp=(v,a,b)=>v<a?a:(v>b?b:v);

  const keys = new Set();
  addEventListener('keydown',e=>{
    if(['Space','ArrowLeft','ArrowRight','KeyZ','KeyX','KeyP','KeyR'].includes(e.code)) e.preventDefault();
    keys.add(e.code);
    if(e.code==='Space' && state.paused && !state.started){ state.started=true; startBanner.classList.add('hidden'); state.paused=false; }
    if(e.code==='KeyP') togglePause();
    if(e.code==='KeyR') restart();
  });
  addEventListener('keyup',e=>keys.delete(e.code));

  pauseBtn.onclick=()=>togglePause();
  restartBtn.onclick=()=>restart();
  retroBtn.onclick=()=>{ document.body.classList.toggle('retro-on'); retroBtn.textContent = document.body.classList.contains('retro-on')?'üïπÔ∏è Retro ‚úì':'üïπÔ∏è Retro'; };

  function togglePause(){ if(state.stage===STAGE.CELEB) return; state.paused=!state.paused; pauseBtn.textContent = state.paused? '‚ñ∂Ô∏è Resume':'‚è∏Ô∏è Pause'; }
  function restart(){ Object.assign(state, initialState()); pauseBtn.textContent='‚è∏Ô∏è Pause'; startBanner.classList.remove('hidden'); }

  class Bike{
    constructor(){ this.lane=2; this.x=laneToX(2); this.targetLane=2; this.jumpT=0; this.jumpDur=0.9; }
    update(dt){
      const L = keys.has('ArrowLeft')||keys.has('KeyZ');
      const R = keys.has('ArrowRight')||keys.has('KeyX');
      if(L&&!R) this.targetLane = clamp(this.targetLane-1,0,LANES-1);
      if(R&&!L) this.targetLane = clamp(this.targetLane+1,0,LANES-1);
      const tx = laneToX(this.targetLane);
      this.x += (tx-this.x) * (TURN_SPEED*(1+state.speed*0.04));
      if(this.jumpT>0){ this.jumpT+=dt; if(this.jumpT>=this.jumpDur) this.jumpT=0; }
    }
    airborne(){ return this.jumpT>0; }
    draw(){
      const y=H*0.8, scale= 1 + (this.airborne()? 0.25*Math.sin((this.jumpT/this.jumpDur)*Math.PI):0);
      ctx.save(); ctx.translate(this.x,y); ctx.scale(scale,scale);
      // wheels
      ctx.fillStyle='#111821'; ctx.beginPath(); ctx.ellipse(-26,18,18,18,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(28,18,18,18,0,0,Math.PI*2); ctx.fill();
      // frame + tank
      ctx.lineWidth=4; ctx.strokeStyle='#c6d0ff'; ctx.beginPath(); ctx.moveTo(-22,6); ctx.lineTo(4,0); ctx.lineTo(26,2); ctx.stroke();
      ctx.fillStyle='#66d0ff'; roundedRect(-8,-8,22,14,6); ctx.fill();
      // headlamp
      ctx.fillStyle='#fffbcc'; ctx.beginPath(); ctx.arc(44,2,8,0,Math.PI*2); ctx.fill();
      // dog rider
      drawDog(-8,-26);
      ctx.restore();
    }
  }

  function drawDog(dx,dy){
    ctx.save(); ctx.translate(dx,dy);
    ctx.fillStyle='#d9b08c'; roundedRect(-12,-8,24,16,6); ctx.fill();
    ctx.fillStyle='#f1c8a6'; ctx.beginPath(); ctx.arc(0,-16,12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#c79d7c'; ctx.beginPath(); ctx.ellipse(-8,-22,5,8,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(8,-22,5,8,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#2b6cf0'; ctx.beginPath(); ctx.arc(0,-18,13,Math.PI,0); ctx.fill();
    ctx.fillStyle='#111821'; roundedRect(-10,-20,8,6,2); ctx.fill(); roundedRect(2,-20,8,6,2); ctx.fill();
    ctx.fillStyle='#8fd3ff'; roundedRect(-9,-19,6,4,1.5); ctx.fill(); roundedRect(3,-19,6,4,1.5); ctx.fill();
    ctx.fillStyle='#eac1a2'; roundedRect(-6,-11,12,7,3); ctx.fill();
    ctx.fillStyle='#111821'; ctx.beginPath(); ctx.arc(0,-7,2,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  class Tractor{
    constructor(lane,speed,monster=true){ this.lane=lane; this.z=0; this.speed=speed; this.monster=monster; this.passed=false; }
    update(dt){ this.z += dt*this.speed*state.speed; }
    off(){ return this.z>1.2; }
    draw(){ const p=projectLane(this.lane,this.z); ctx.save(); ctx.translate(p.x,p.y); ctx.scale(p.s,p.s); drawTractor(this.monster); ctx.restore(); }
  }
  class Combine{
    constructor(lane,speed,boss=false){ this.lane=lane; this.z=0; this.speed=speed; this.boss=boss; }
    update(dt){ this.z += dt*this.speed*state.speed*1.1; }
    off(){ return this.z>1.2; }
    draw(){ const p=projectLane(this.lane,this.z); ctx.save(); ctx.translate(p.x,p.y); ctx.scale(p.s*1.25,p.s*1.25); drawCombine(this.boss); ctx.restore(); }
  }
  class Ramp{
    constructor(lane){ this.lane=lane; this.z=0; this.speed=0.9; }
    update(dt){ this.z += dt*this.speed*state.speed; }
    off(){ return this.z>1.1; }
    draw(){ const p=projectLane(this.lane,this.z); ctx.save(); ctx.translate(p.x,p.y+10); ctx.scale(p.s,p.s); drawRamp(); ctx.restore(); }
  }
  // Retro roadside billboards (dog food & motorbikes)
  class Billboard{
    constructor(side){ // -1 left, +1 right
      this.side=side; this.z=0; this.speed=0.45;
      const ads=[{h1:'K9 CRUNCH',h2:'DOG FOOD',c:'#ffdc5d'},
                 {h1:'BARK-O-LUBE',h2:'MOTO OIL',c:'#9bf6ff'},
                 {h1:'VINTAGE',h2:'MOTORBIKES',c:'#ffd6a5'},
                 {h1:'DOG FUEL',h2:'PREMIUM',c:'#caffbf'},
                 {h1:'GOGGLES',h2:'FOR DOGS',c:'#bdb2ff'}];
      const p=ads[(Math.random()*ads.length)|0]; this.h1=p.h1; this.h2=p.h2; this.c=p.c;
    }
    update(dt){ this.z += dt*this.speed*(1+state.speed*0.05); }
    off(){ return this.z>1.15; }
    draw(){
      const p=projectSide(this.side,this.z);
      ctx.save(); ctx.translate(p.x,p.y); ctx.scale(p.s,p.s);
      ctx.fillStyle='#6c7a89'; ctx.fillRect(-4,0,8,50); // pole
      ctx.save(); ctx.translate(0,-10); ctx.rotate(this.side*-0.06);
      ctx.fillStyle=this.c; roundedRect(-60,-40,120,80,8); ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.stroke();
      ctx.fillStyle='#1c2238'; ctx.textAlign='center';
      ctx.font='bold 16px system-ui'; ctx.fillText(this.h1,0,-6);
      ctx.font='700 14px system-ui'; ctx.fillText(this.h2,0,14);
      ctx.restore(); ctx.restore();
    }
  }
  class CheerDog{
    constructor(x,y){this.x=x;this.y=y;this.vy= -rand(3,6);this.g=0.2;}
    update(){ this.y+=this.vy; this.vy+=this.g; if(this.y>H-60){ this.y=H-60; this.vy*=-0.6; } }
    draw(){ ctx.save(); ctx.translate(this.x,this.y); drawDog(0,0);
      ctx.fillStyle='#f5c542'; ctx.beginPath(); ctx.arc(22,-6,6,0,Math.PI*2); ctx.fill(); ctx.fillRect(20,0,4,10); ctx.fillRect(15,10,14,6);
      ctx.restore(); }
  }

  function roundedRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  function drawRoad(){
    ctx.save();
    ctx.fillStyle=roadGrad(); ctx.beginPath();
    ctx.moveTo((W-ROAD_W_TOP)/2,HORIZON);
    ctx.lineTo((W+ROAD_W_TOP)/2,HORIZON);
    ctx.lineTo((W+ROAD_W_BOTTOM)/2,H);
    ctx.lineTo((W-ROAD_W_BOTTOM)/2,H);
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.lineWidth=2;
    for(let i=1;i<LANES;i++){
      const t=i/LANES;
      const xTop=W/2-ROAD_W_TOP/2+ROAD_W_TOP*t;
      const xBottom=W/2-ROAD_W_BOTTOM/2+ROAD_W_BOTTOM*t;
      ctx.beginPath(); ctx.moveTo(xTop,HORIZON); ctx.lineTo(xBottom,H); ctx.stroke();
    }
    ctx.fillStyle='#254117'; ctx.fillRect(0,HORIZON-2,W,8);
    ctx.restore();
  }
  function roadGrad(){ const g=ctx.createLinearGradient(0,HORIZON,0,H); g.addColorStop(0,'#23273b'); g.addColorStop(1,`rgb(${235+((Math.random()*6)|0)},${238+((Math.random()*6)|0)},${245+((Math.random()*6)|0)})`); return g; }

  function drawTractor(monster){
    ctx.fillStyle = monster? '#dc2f5a' : '#8892b0'; roundedRect(-40,-28,80,56,10); ctx.fill();
    ctx.fillStyle='#5ad1ff'; roundedRect(-20,-42,40,26,6); ctx.fill();
    ctx.fillStyle='#161925'; ctx.beginPath(); ctx.ellipse(-26,24,16,16,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(28,24,16,16,0,0,Math.PI*2); ctx.fill();
    if(monster){ ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-12,-8,6,0,Math.PI*2); ctx.arc(12,-8,6,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(-12,-8,3,0,Math.PI*2); ctx.arc(12,-8,3,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#ffe08a'; roundedRect(-14,2,28,10,3); ctx.fill();
      ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-12,7); for(let i=-12;i<=12;i+=6){ ctx.lineTo(i+3,2); ctx.lineTo(i+6,7);} ctx.stroke(); }
  }
  function drawCombine(boss){
    ctx.fillStyle = boss? '#ff7a00' : '#2bd676'; roundedRect(-60,-36,120,72,10); ctx.fill();
    ctx.fillStyle='#71e2ff'; roundedRect(-28,-54,56,30,8); ctx.fill();
    ctx.fillStyle='#161925'; ctx.beginPath(); ctx.ellipse(-40,30,18,18,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(40,30,18,18,0,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.beginPath(); for(let i=-50;i<=50;i+=10){ ctx.moveTo(i,12); ctx.lineTo(i+5,18);} ctx.stroke();
    if(boss){ ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(0,-10,10,0,Math.PI*2); ctx.fill(); }
  }
  function drawRamp(){ ctx.fillStyle='rgba(255,209,102,0.95)'; ctx.beginPath(); ctx.moveTo(-30,16); ctx.lineTo(30,16); ctx.lineTo(24,-4); ctx.lineTo(-24,4); ctx.closePath(); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=2; ctx.stroke(); }

  function laneToX(l){ const left=(W-ROAD_W_BOTTOM)/2, per=ROAD_W_BOTTOM/LANES; return left + per*(l+0.5); }
  function projectLane(l,z){ const roadW=ROAD_W_TOP+(ROAD_W_BOTTOM-ROAD_W_TOP)*z; const x=W/2-roadW/2+roadW*(l+0.5)/LANES; const y=HORIZON+(H-HORIZON)*z; const s=0.3+z*1.1; return {x,y,s}; }
  function projectSide(side,z){ const roadW=ROAD_W_TOP+(ROAD_W_BOTTOM-ROAD_W_TOP)*z; const edge=(side<0? (W/2-roadW/2):(W/2+roadW/2)); const off=60+40*z; const x=edge+side*off; const y=HORIZON+(H-HORIZON)*z; const s=0.35+z*1.0; return {x,y,s}; }

  function initialState(){ return {
    started:false, paused:true, stage:STAGE.ROAD, bike:new Bike(),
    obstacles:[], ramps:[], billboards:[], cheers:[],
    spawnT:0, rampT:0, billT:0, score:0, speed:1, time:0, finalQueue:0, gameOver:false
  }; }
  const state = initialState();

  function spawnWave(dt){
    if(state.stage===STAGE.ROAD || state.stage===STAGE.HARVEST){
      state.spawnT -= dt;
      const target = state.stage===STAGE.ROAD ? (0.9 - Math.min(0.5, state.score/120)) : 0.6;
      if(state.spawnT<=0){
        const lane = (Math.random()*LANES)|0;
        (state.stage===STAGE.ROAD)
          ? state.obstacles.push(new Tractor(lane, rand(0.35,0.5), true))
          : state.obstacles.push(new Combine(lane, rand(0.38,0.52), false));
        state.spawnT = target;
      }
    }
    if(state.stage!==STAGE.FINAL && state.stage!==STAGE.CELEB){
      state.rampT -= dt;
      if(state.rampT<=0){ state.ramps.push(new Ramp((Math.random()*LANES)|0)); state.rampT = rand(2.2,4.0); }
      state.billT -= dt;
      if(state.billT<=0){ state.billboards.push(new Billboard(Math.random()<.5?-1:1)); state.billT = rand(1.6,2.6); }
    }
    if(state.stage===STAGE.FINAL && state.finalQueue>0){
      state.spawnT -= dt;
      if(state.spawnT<=0){
        const remain=state.finalQueue;
        if(remain>1){ state.obstacles.push(new Combine((Math.random()*LANES)|0, 0.55, false)); state.spawnT=0.55; }
        else{
          const bossLane=(Math.random()*LANES)|0;
          state.ramps.push(new Ramp(bossLane)); state.ramps[state.ramps.length-1].z=-0.08;
          state.obstacles.push(new Combine(bossLane, 0.6, true)); state.spawnT=2;
        }
        state.finalQueue--;
      }
    }
  }

  function handleInteractions(){
    for(const r of state.ramps){
      const pr=projectLane(r.lane,r.z), dx=Math.abs(state.bike.x-pr.x), dy=(H*0.8)-pr.y;
      if(!state.bike.airborne() && r.z>0.78 && r.z<0.95 && dx<40){ state.bike.jumpT=0.01; toastMsg('WOOF! +10'); }
    }
    for(const o of state.obstacles){
      const p=projectLane(o.lane,o.z);
      if(!o.passed && p.y>H*0.82){
        o.passed=true; addScore(state.bike.airborne()?10:5);
        if(state.stage===STAGE.ROAD && state.score>=50){ state.stage=STAGE.HARVEST; stageEl.textContent=state.stage; }
        if(state.stage===STAGE.HARVEST && state.score>=70){ state.stage=STAGE.FINAL; stageEl.textContent=state.stage; state.finalQueue=4; state.spawnT=0.6; }
      }
      if(!state.bike.airborne()){
        const dx=Math.abs(state.bike.x-p.x), dy=Math.abs(H*0.8-p.y), hit=dx<48*p.s && dy<36*p.s;
        if(hit){ flash(); return crash(); }
      } else { if(Math.random()<0.01) bubble('WOOF!'); }
    }
    if(state.stage===STAGE.FINAL){
      for(const o of state.obstacles){
        if(o instanceof Combine && o.boss){
          const p=projectLane(o.lane,o.z);
          if(p.y>H*0.83 && !state.gameOver){
            if(state.bike.airborne()){ addScore(20); return celebrate(); }
            else { flash(); return crash(); }
          }
        }
      }
    }
  }

  function addScore(n){ state.score+=n; scoreEl.textContent=state.score; if(n===10) bubble('WOOF!'); }
  function bubble(t){ toastMsg(t); }
  function toastMsg(t){ toast.textContent=t; toast.classList.add('show'); clearTimeout(toastMsg._t); toastMsg._t=setTimeout(()=>toast.classList.remove('show'),520); }
  function flash(){ canvas.style.filter='saturate(2) brightness(1.6)'; setTimeout(()=>canvas.style.filter='none',180); }
  function celebrate(){
    state.stage=STAGE.CELEB; stageEl.textContent='Victory!'; state.gameOver=true; state.paused=true;
    for(let i=0;i<26;i++) state.cheers.push(new CheerDog(rand(40,W-40), rand(H*0.35,H*0.75)));
    setTimeout(()=>{ startBanner.classList.remove('hidden');
      startBanner.querySelector('.title').textContent='Victory!';
      startBanner.querySelector('.subtitle').textContent='You cleared the Terrible Harvest. The pack is proud.'; },200);
  }
  function crash(){ state.gameOver=true; state.paused=true; stageEl.textContent='Crashed';
    startBanner.classList.remove('hidden');
    startBanner.querySelector('.title').textContent='Crash!';
    startBanner.querySelector('.subtitle').textContent='A tractor ended your run. Press Space to try again.';
  }

  let last=performance.now();
  function loop(ts){
    const dt=Math.min(0.04,(ts-last)/1000); last=ts;
    if(!state.paused && state.started){
      const boosting=keys.has('Space'); state.speed=(1+Math.min(0.8,state.score/150))*(boosting?BOOST_MULT:1); speedEl.textContent=state.speed.toFixed(2)+'x';
      state.bike.update(dt);
      spawnWave(dt);
      for(const o of state.obstacles) o.update(dt);
      for(const r of state.ramps) r.update(dt);
      for(const b of state.billboards) b.update(dt);
      for(const c of state.cheers) c.update();
      handleInteractions();
      state.obstacles = state.obstacles.filter(o=>!o.off());
      state.ramps = state.ramps.filter(r=>!r.off());
      state.billboards = state.billboards.filter(b=>!b.off());
    }
    draw();
    requestAnimationFrame(loop);
  }

  function draw(){
    const sky=ctx.createLinearGradient(0,0,0,H); sky.addColorStop(0,'#081028'); sky.addColorStop(1,'#0b1330');
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
    drawStars(); drawRoad();
    ctx.fillStyle='rgba(30,40,60,.8)'; ctx.fillRect(40,HORIZON-22,90,18); ctx.fillRect(W-180,HORIZON-20,140,16);
    const all=[ ...state.billboards.map(b=>({z:b.z,draw:()=>b.draw()})),
                ...state.ramps.map(r=>({z:r.z,draw:()=>r.draw()})),
                ...state.obstacles.map(o=>({z:o.z,draw:()=>o.draw()})) ].sort((a,b)=>a.z-b.z);
    for(const a of all) a.draw();
    state.bike.draw();
    if(state.stage===STAGE.CELEB) for(const c of state.cheers) c.draw();
  }
  function drawStars(){ ctx.save(); ctx.globalAlpha=.6; ctx.fillStyle='white'; for(let i=0;i<40;i++) ctx.fillRect(Math.random()*W, Math.random()*HORIZON, 1,1); ctx.restore(); }

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
